---
teardown:
  # Shutdown external logging just in case
  - do:
      cluster.put_settings:
        body:
          transient:
            external_logging.host: null

---
"Check index creation log":
  # Fetch the http host. We use the host of the master because we know there will always be a master.
  - do:
      cluster.state: {}
  - set: { master_node: master }
  - do:
      nodes.info:
        metric: [ http ]
  - is_true: nodes.$master.http.publish_address
  - set: {nodes.$master.http.publish_address: host}

  # enabled logging to the the Elasticsearch node
  - do:
      cluster.put_settings:
        body:
          transient:
            external_logging.host: http://${host}/log/log

  - do:
      index:
        index:  twitter
        type:   tweet
        id:     1
        body:   { "user": "kimchy" }

  - do:
      flush_external_logging: {}
  - do:
    indices.refresh:
      index: log

  - do:
      search:
        index: log
        q:     message:twitter
  - match: { hits.total: 2 }

---
"Shut down and start up":
  # Fetch the http host. We use the host of the master because we know there will always be a master.
  - do:
      cluster.state: {}
  - set: { master_node: master }
  - do:
      nodes.info:
        metric: [ http ]
  - is_true: nodes.$master.http.publish_address
  - set: {nodes.$master.http.publish_address: host}

  # Turn on logging, shut it down, and turn it on again. Turning it back on
  # should work!
  - do:
      cluster.put_settings:
        body:
          transient:
            external_logging.host: http://${host}/log/log
  - do:
      cluster.put_settings:
        body:
          transient:
            external_logging.host: null
  - do:
      cluster.put_settings:
        body:
          transient:
            external_logging.host: http://${host}/log/log

  # Create an index so we make a log that we can search for.
  - do:
      index:
        index:  twitter
        type:   tweet
        id:     1
        body:   { "user": "kimchy" }

  - do:
      flush_external_logging: {}
  - do:
    indices.refresh:
      index: log

  - do:
      search:
        index: log
        q:     message:twitter
  - match: { hits.total: 2 }
